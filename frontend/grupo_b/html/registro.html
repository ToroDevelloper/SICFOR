<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Estudiante - SICFOR</title>
  <link rel="stylesheet" href="../css/registro.css">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <header>
    <h1>SICFOR - Registro y Gestión de Estudiantes</h1>
    <p>Módulo de Estudiantes</p>
  </header>

  <nav>
    <ul>
      <li><a href="lista.html">Lista de Estudiantes</a></li>
      <li><a href="registro.html">Registro</a></li>
    </ul>
  </nav>

  <main>
    <h2 id="tituloRegistro">Registro de Nuevo Estudiante</h2>

    <form id="formularioRegistro" enctype="multipart/form-data">
      <fieldset>
        <legend>Información Personal</legend>
        <label for="nombres">Nombres: *</label>
        <input type="text" id="nombres" name="nombres" required maxlength="100">

        <label for="apellidos">Apellidos: *</label>
        <input type="text" id="apellidos" name="apellidos" required maxlength="100">
      </fieldset>

      <fieldset>
        <legend>Documento de Identidad</legend>
        <label for="tipo_documento">Tipo de Documento: *</label>
        <select id="tipo_documento" name="tipo_documento" required>
          <option value="">Seleccione...</option>
          <option value="CC">Cédula de Ciudadanía (CC)</option>
          <option value="TI">Tarjeta de Identidad (TI)</option>
          <option value="CE">Cédula de Extranjería (CE)</option>
          <option value="PASAPORTE">Pasaporte</option>
        </select>

        <label for="numero_identificacion">Número de Identificación: *</label>
        <input type="text" id="numero_identificacion" name="numero_identificacion" required minlength="5" maxlength="20" pattern="\d+">

        <label for="fecha_nacimiento">Fecha de Nacimiento: *</label>
        <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" required>
      </fieldset>

      <fieldset>
        <legend>Datos de Contacto</legend>
        <label for="email">Correo Electrónico: *</label>
        <input type="email" id="email" name="email" required maxlength="100">

        <label for="celular">Celular:</label>
        <input type="tel" id="celular" name="celular" maxlength="15" pattern="\d+">

        <label for="direccion">Dirección:</label>
        <input type="text" id="direccion" name="direccion" maxlength="200">
      </fieldset>

      <fieldset>
        <legend>Lugar de Nacimiento</legend>
        <label for="departamento_nacimiento">Departamento de Nacimiento:</label>
        <input type="text" id="departamento_nacimiento" name="departamento_nacimiento" maxlength="100">

        <label for="municipio_nacimiento">Municipio de Nacimiento:</label>
        <input type="text" id="municipio_nacimiento" name="municipio_nacimiento" maxlength="100">
      </fieldset>

      <fieldset>
        <legend>Lugar de Residencia</legend>
        <label for="departamento_residencia">Departamento de Residencia:</label>
        <input type="text" id="departamento_residencia" name="departamento_residencia" maxlength="100">

        <label for="municipio_residencia">Municipio de Residencia:</label>
        <input type="text" id="municipio_residencia" name="municipio_residencia" maxlength="100">

        <label for="zona">Zona:</label>
        <select id="zona" name="zona">
          <option value="">Seleccione...</option>
          <option value="Urbana">Urbana</option>
          <option value="Rural">Rural</option>
        </select>
      </fieldset>

      <div>
        <button type="submit" id="btnSubmit">Registrar Estudiante</button>
        <button type="reset">Limpiar Formulario</button>
        <button type="button" onclick="window.location.href='lista.html'">Ir a Lista</button>
      </div>
    </form>
  </main>

  <footer>
    <p>Registro y Gestión de Estudiantes | SICFOR &copy; 2025</p>
  </footer>

  <!-- Conexión con backend -->
  <script src="../js/index.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    const form = document.getElementById('formularioRegistro');
    const titulo = document.getElementById('tituloRegistro');
    const btnSubmit = document.getElementById('btnSubmit');

    if (id) {
      titulo.textContent = 'Editar Estudiante';
      btnSubmit.textContent = 'Actualizar Estudiante';

      obtenerEstudiante(id).then(est => {
        for (const campo in est) {
          if (document.getElementById(campo)) {
            document.getElementById(campo).value = est[campo];
          }
        }
      }).catch(err => {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error al cargar datos del estudiante'
        });
        console.error(err);
      });
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();

      const estudiante = {};
      Array.from(form.elements).forEach(el => {
        if (el.name && el.type !== 'file') estudiante[el.name] = el.value;
      });

      try {
        let res;
        if (id) {
          res = await actualizarEstudiante(id, estudiante);
          Swal.fire({
            icon: 'success',
            title: 'Estudiante actualizado',
            text: res.message || 'Actualización realizada correctamente'
          });
        } else {
          res = await crearEstudiante(estudiante);
          Swal.fire({
            icon: 'success',
            title: 'Estudiante registrado',
            text: res.message || 'Registro realizado correctamente'
          });
        }
        
        // Redirección después de mostrar alerta
        setTimeout(() => {
          if (id) {
            window.location.href = `perfil.html?id=${id}`;
          } else {
            window.location.href = 'lista.html';
          }
        }, 1500);

      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Error en la operación'
        });
        console.error(err);
      }
    });
  </script>
</body>
</html>